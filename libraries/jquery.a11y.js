define(["jquery","underscore"],function(h,d){var t=/iPad|iPhone|iPod/.test(navigator.platform),i={globalTabIndexElementFilter:":not(.a11y-ignore):not([data-a11y-force-focus])",focusableElementsFilter:":visible:not(.disabled):not(:disabled):not([aria-hidden=true]):not(.a11y-ignore-focus)",ariaLabelElementsFilter:":not( .a11y-ignore-aria [aria-label] )",ariaHiddenParentsFilter:":not(#wrapper):not(body)"},s={focuser:"#a11y-focuser",focusguard:".a11y-focusguard",ignoreFocusElements:".a11y-ignore-focus",nativeSpaceElements:"textarea, input[type='text'], div[contenteditable=true]",nativeEnterElements:"textarea, a, button, input[type='checkbox'], input[type='radio']",nativeTabElements:"textarea, input, select",wrapIgnoreElements:"a,button,input,select,textarea",wrapStyleElements:"b,i,abbr,strong,em,small,sub,sup,ins,del,mark,zw,nb",globalTabIndexElements:"a,button,input,select,textarea,[tabindex]:not([data-a11y-force-focus])",focusableElements:"a,button,input,select,textarea,[tabindex],label",focusableElementsAccessible:":not(a,button,input,select,textarea)[tabindex]",hideableElements:".a11y-hideable",ariaLabelElements:"div[aria-label], span[aria-label]",readableElements:"[role=heading],[aria-label],[aria-labelledby],[alt]"},n='<div id="a11y-focuser" class="a11y-ignore" tabindex="-1" role="presentation">&nbsp;</div>';function r(e){return e.replace(r.regex,"")}function a(e,t,n){var a=t||this,i=arguments;return setTimeout(function(){e.apply(a,i)},n||0)}function l(e){var t=h.a11y.state,n=h.a11y.options;if((n.isDebug&&console.log("preventScroll1"),t.scrollDisabledElements&&0<t.scrollDisabledElements.length)&&0===c(e).filter(t.scrollDisabledElements).length)return void h(window).scroll();return n.isDebug&&console.log("preventScroll2"),e.preventDefault(),!1}r.regex=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;var o={37:1,38:1,39:1,40:1};function u(e){var t=h.a11y.state,n=h.a11y.options;if(!h(e.target).is(s.nativeTabElements)){if(n.isDebug&&console.log("preventScroll1"),t.scrollDisabledElements&&0<t.scrollDisabledElements.length)if(0===c(e).filter(t.scrollDisabledElements).length)return;return n.isDebug&&console.log("preventScroll2"),o[e.keyCode]?(l(e),!1):void 0}}function c(e){var t,n,a=h(e.target);if("touchmove"==e.type){var i=h.a11y.state;if(!i.scrollStartEvent||!i.scrollStartEvent.originalEvent)return a;var r=e.originalEvent.pageY,l=i.scrollStartEvent.originalEvent.pageY;if(0!==r&&r!=l||(r=e.originalEvent.touches[0].pageY,l=i.scrollStartEvent.originalEvent.touches[0].pageY),0===(t=r-l))return h("body");n=0<t?"up":"down"}else{if(0===(t=e.originalEvent.wheelDeltaY||void 0!==e.originalEvent.deltaY?-e.originalEvent.deltaY:e.originalEvent.wheelDelta||void 0))return h("body");n=0<t?"up":"down"}for(var o=a.parents(),s=0,d=o.length;s<d;s++){var u=h(o[s]);if(u.is("body"))return u;switch(u.css("overflow-y")){case"auto":case"scroll":var c=Math.ceil(u.scrollTop()),f=u.outerHeight(),b=u[0].scrollHeight;switch(n){case"down":if(c+f<b)return u;break;case"up":if(0<c)return u}u}}return h("body")}function f(e){var t=h.a11y.options,n=h(e.target),a=h().add(n).add(n.parents()).filter(s.globalTabIndexElements);a.length&&(t.isDebug&&console.log("clicked",a[0]),a[0].focus())}function b(e){var t=h.a11y.options,n=h.a11y.state,a=h(e.target);a.is(s.globalTabIndexElements)&&(!function(e){var t;if(e.attr("aria-labelledby")){var n=h("#"+e.attr("aria-labelledby"));t=n.attr("aria-label")||n.text()}else t=e.attr("aria-label")||e.text();h(document).trigger("reading",r(t))}(a),t.isDebug&&console.log("focus",a[0]),n.$activeElement=h(e.target))}function v(e){var t=e.target,n=h(t);n.is("[data-a11y-force-focus]")&&n.removeAttr("tabindex data-a11y-force-focus"),e.target===e.currentTarget&&n.is("[disabled]")&&n.focusNext()}function g(e){return h.a11y.state.scrollStartEvent=e,!0}function y(e){return!(h.a11y.state.scrollStartEvent=null)}function m(e){return l(h.event.fix(e))}function p(){var n=h.a11y.options;h.a11y.state.isFocusGuardSetup||(h.a11y.state.isFocusGuardSetup=!0,h("body").on("click focus",s.focusguard,function(e){var t;return n.isDebug&&console.log("focusguard"),t=e,h.a11y.options.isDebug&&console.log("preventDefault"),t.preventDefault(),t.stopPropagation(),h.a11y_focus(!0),!1}))}h.fn.scrollDisable=function(){if(0===this.length)return this;var e,t=h.a11y.options,n=h.a11y.state;return t.isScrollDisableEnabled&&(n.scrollDisabledElements?n.scrollDisabledElements=n.scrollDisabledElements.add(this):n.scrollDisabledElements=h(this),0<n.scrollDisabledElements.length&&(e="wheel mousewheel",h(window).on(e,l),h(document).on(e,l),h(window).on("touchstart",g),window.addEventListener("touchmove",m,{passive:!1}),h(window).on("touchend",y),h(document).on("keydown",u))),this},h.fn.scrollEnable=function(){if(0===this.length)return this;var e,t=h.a11y.options,n=h.a11y.state;if(!t.isScrollDisableEnabled)return this;n.scrollDisabledElements&&(n.scrollDisabledElements=n.scrollDisabledElements.not(this),0===n.scrollDisabledElements.length&&(e="wheel mousewheel",h(window).off(e,l),h(document).off(e,l),h(window).off("touchstart",g),window.removeEventListener("touchmove",m),h(window).off("touchend",y),h(document).off("keydown",u)))},h.fn.isFixedPostion=function(){if(0===this.length)return!1;var e=h(this[0]);if(!e)return!1;if("fixed"==e.css("position"))return!0;if(e.is(".fixed"))return!0;for(var t=e.parents(),n=0,a=t.length;n<a;n++){if("fixed"==h(t[n]).css("position"))return!0;if(h(t[n]).is(".fixed"))return!0}return!1},h.fn.limitedScrollTo=function(){return console.warn("REMOVED $.limitedScrollTo had no impact on the screen reader cursor."),this},h.fn.focusNoScroll=function(){if(0===this.length)return this;h.a11y.options.isDebug&&console.log("focusNoScroll",this[0]);var e=h(window).scrollTop();try{void 0===this.attr("tabindex")&&this.attr({tabindex:"-1","data-a11y-force-focus":"true"}),this[0].focus()}catch(e){}return window.scrollTo(null,e),this},h.fn.focusNext=function(e){if(0===this.length)return this;var t=h(this[0]),n=t.findForward(function(e){return e.isReadable()});return n=n||t.not("*"),!e&&n&&n.focusNoScroll(),n},h.fn.focusOrNext=function(e){if(0===this.length)return this;var t,n=h(this[0]);return n.isReadable(!0)||(t=n.findForward(function(e){return e.isReadable()})),t=t||n,!e&&t&&t.focusNoScroll(),t},h.fn.findForward=function(t){var a;switch(typeof t){case"string":a=function(e){return e.is(t)||void 0};break;case"function":a=t;break;case"undefined":a=Boolean}if(0===this.length)return this.not("*");var i=this.findWalk(a);if(i&&i.length)return i;var e=this.nextAll().toArray();if(d.find(e,function(e){var t=h(e),n=a(t);if(!1!==n)return n?(i=t,!0):!(!(i=t.findWalk(a))||!i.length)||void 0}),i&&i.length)return i;var n=this.add(this.parents()).toArray().reverse();return d.find(n,function(e){var t=h(e);if(!1===a(t))return!1;var n=t.nextAll().toArray();return d.find(n,function(e){var t=h(e),n=a(t);if(!1!==n)return n?(i=t,!0):!(!(i=t.findWalk(a))||!i.length)||void 0})}),i&&i.length?i:this.not("*")},h.fn.findWalk=function(t){var a;switch(typeof t){case"string":a=function(e){return e.is(t)||void 0};break;case"function":a=t;break;case"undefined":a=Boolean}var e=this.not("*");if(0===this.length)return e;var i=[{item:this[0],value:void 0}],n=0,r=n+1;do{var l=i[n],o=h(l.item);switch(l.value){case!0:return o;case!1:return e}var s=o.children().toArray();d.find(s,function(e){var t=h(e),n=a(t);if(!1===n)return!1;i.splice(r++,0,{item:e,value:n})}),r=++n+1}while(n<i.length);return e},h.fn.isReadable=function(e){var t=this[0],n=h(t),a=e?n.add(n.parents()):n;if(d.find(a.toArray(),function(e){var t=h(e);if("none"===t.css("display")||"hidden"===t.css("visibility")||"true"===t.attr("aria-hidden"))return!0}))return!1;if(n.is(s.focusableElements)||n.is(s.readableElements))return!0;for(var i=t.childNodes,r=0,l=i.length;r<l;r++){var o=i[r];if(3===o.nodeType)if(!/^\s*$/.test(o.nodeValue))return!0}},h.a11y=function(e,t){return h.a11y.options.isDebug&&console.log("$.a11y called",e,t),this},h.a11y.options={OS:"",isFocusControlEnabled:!0,isRemoveNotAccessiblesEnabled:!0,isScrollDisableEnabled:!0,isScrollDisabledOnPopupEnabled:!1,isDebug:!1},h.a11y.state={$activeElement:null,floorStack:[h("body")],focusStack:[],tabIndexes:{},ariaHiddens:{},elementUIDIndex:0,scrollDisabledElements:null,scrollStartEvent:null},h.a11y.ready=function(){var e=h.a11y.options;t&&(e.OS="mac"),0===h(s.focuser).length&&h("body").append(h(n)),p(),e.isFocusControlEnabled&&function(){h.a11y.options;var e=h("body");e.off("focus","*",b).off("blur","*",v).off("focus",b).off("blur",v),e.on("focus","*",b).on("blur","*",v).on("focus",b).on("blur",v),e[0].removeEventListener("click",f),e[0].addEventListener("click",f,!0)}()},h.a11y_update=function(){var e=h.a11y.options;t&&(e.OS="mac"),e.isRemoveNotAccessiblesEnabled&&h(".not-accessible[tabindex='0'], .not-accessible [tabindex='0']").attr({tabindex:"-1","aria-hidden":!0}).addClass("aria-hidden"),e.isDebug&&console.log("a11y_update")},h.a11y_on=function(e,t){return h.a11y.options.isDebug&&console.log("$.a11y_on called",e,t),t=t||"body",!1===(e=void 0===e||e)?h(t).attr("aria-hidden",!0):h(t).removeAttr("aria-hidden"),this},h.fn.a11y_on=function(e){return 0===this.length||(h.a11y.options.isDebug&&console.log("$.fn.a11y_on called",e,this),(e=void 0===e||e)?this.find(s.hideableElements).filter(i.globalTabIndexElementFilter).attr("aria-hidden","true").attr("tabindex","-1").addClass("aria-hidden"):this.find(s.hideableElements).filter(i.globalTabIndexElementFilter).attr("aria-hidden","false").removeAttr("tabindex").removeClass("aria-hidden"),this.find(s.globalTabIndexElements).filter(i.globalTabIndexElementFilter).a11y_cntrl(e)),this},h.fn.a11y_cntrl=function(e,t){if(0===this.length)return this;h.a11y.options;e=void 0===e||e;for(var n=0;n<this.length;n++){var a=h(this[n]);e&&a.is(s.hideableElements)?(a.removeAttr("aria-hidden").removeClass("aria-hidden"),a.parents(i.parentsFilter).removeAttr("aria-hidden").removeClass("aria-hidden"),t&&a.removeAttr("disabled").removeClass("disabled")):e?(a.attr({tabindex:"0"}).removeAttr("aria-hidden").removeClass("aria-hidden"),a.parents(i.parentsFilter).removeAttr("aria-hidden").removeClass("aria-hidden"),t&&a.removeAttr("disabled").removeClass("disabled")):(a.attr({tabindex:"-1","aria-hidden":"true"}).addClass("aria-hidden"),t&&a.attr("disabled","disabled").addClass("disabled"))}return this},h.fn.a11y_cntrl_enabled=function(e){return 0===this.length?this:this.a11y_cntrl(e,!0)};var E=/&.*;/g;h.a11y_normalize=function(e){h.a11y.options;return e=(e=h("<div>"+e+"</div>").text()).replace(E,"")},h.a11y_remove_breaks=function(e){h.a11y.options;var t=[h("<div>"+e+"</div>")[0]],n=0,a=[];do{if(t[n].childNodes.length){var i=t[n].childNodes,r=d.filter(i,function(e){return 3===e.nodeType||!!h(e).is(s.wrapStyleElements)});a.push.apply(a,r),t.push.apply(t,i)}n++}while(n<t.length);var l="";return a.forEach(function(e){l+=e.outerHTML||e.textContent}),l},h.a11y_text=function(e){return console.log("DEPRECATED: a11y_text is no longer required. https://tink.uk/understanding-screen-reader-interaction-modes/"),e},h.fn.a11y_text=function(e){return console.log("DEPRECATED: a11y_text is no longer required. https://tink.uk/understanding-screen-reader-interaction-modes/"),this},h.fn.a11y_selected=function(e,t){return console.log("REMOVED - $.fn.a11y_selected is removed. Please use aria-live instead."),this},h.a11y_alert=function(e){return console.log("REMOVED - $.a11y_alert is removed. Please use aria-live instead."),this},h.fn.a11y_only=function(e,l){if(0===this.length)return this;var t,n,o=h.a11y.state;l&&o.focusStack.push(o.$activeElement),n=void 0!==e?(t=h(e).find(s.globalTabIndexElements).filter(i.globalTabIndexElementFilter),h(e).find(s.hideableElements).filter(i.globalTabIndexElementFilter)):(t=h(s.globalTabIndexElements).filter(i.globalTabIndexElementFilter),h(s.hideableElements).filter(i.globalTabIndexElementFilter));var a=this.add(this.parents()).siblings().filter(i.globalTabIndexElementFilter);return(t=t.add(a)).each(function(e,t){var n,a=h(t);if(null==t.a11y_uid&&(t.a11y_uid="UID"+ ++o.elementUIDIndex),n=t.a11y_uid,l){void 0===o.tabIndexes[n]&&(o.tabIndexes[n]=[]),void 0===o.ariaHiddens[n]&&(o.ariaHiddens[n]=[]);var i=a.attr("tabindex"),r=a.attr("aria-hidden");o.tabIndexes[n].push(void 0===i?"":i),o.ariaHiddens[n].push(void 0===r?"":r)}a.attr({tabindex:-1,"aria-hidden":!0})}),n.attr("aria-hidden",!0).attr("tabindex","-1"),this.find(s.globalTabIndexElements).filter(i.globalTabIndexElementFilter).attr({tabindex:0}).removeAttr("aria-hidden").removeClass("aria-hidden").parents(i.ariaHiddenParentsFilter).removeAttr("aria-hidden").removeClass("aria-hidden"),this.find(s.hideableElements).filter(i.globalTabIndexElementFilter).removeAttr("tabindex").removeAttr("aria-hidden").removeClass("aria-hidden").parents(i.parentsFilter).removeAttr("aria-hidden").removeClass("aria-hidden"),h.a11y_update(),this},h.fn.a11y_popup=function(e){if(0===this.length)return this;var t=h.a11y.options;return h.a11y.state.floorStack.push(this),this.a11y_only(e,!0),t.isScrollDisabledOnPopupEnabled&&(h("html").css("overflow-y","hidden"),h.a11y.state.floorStack[h.a11y.state.floorStack.length-2].scrollDisable()),this},h.a11y_popdown=function(){var e=h.a11y.options,l=h.a11y.state;if(!(h.a11y.state.floorStack.length<=1)){h.a11y.state.floorStack.pop();h(s.globalTabIndexElements).filter(i.globalTabIndexElementFilter).each(function(e,t){var n,a=h(t),i="",r="";null==t.a11y_uid&&(t.a11y_uid="UID"+ ++l.elementUIDIndex),n=t.a11y_uid,void 0!==l.tabIndexes[n]&&0!==l.tabIndexes[n].length&&(i=l.tabIndexes[n].pop(),r=l.ariaHiddens[n].pop()),void 0!==l.tabIndexes[n]&&0<l.tabIndexes[n].length&&(delete l.tabIndexes[n],delete l.ariaHiddens[n]),""===i?a.removeAttr("tabindex"):a.attr({tabindex:i}),""===r?a.removeAttr("aria-hidden"):a.attr({"aria-hidden":r}),a.is(s.hideableElements)&&a.removeAttr("tabindex")});var t=l.$activeElement=l.focusStack.pop();return h.a11y_update(),e.isScrollDisabledOnPopupEnabled&&(1==l.floorStack.length&&h("html").css("overflow-y",""),h.a11y.state.floorStack[h.a11y.state.floorStack.length-1].scrollEnable()),t}},h.a11y_focus=function(e){return e?h("body").focusOrNext():a(function(){h("body").focusOrNext()}),this},h.fn.a11y_focus=function(e){return 0===this.length||(e?this.focusOrNext():a(function(){this.focusOrNext()},this)),this},h.fn.a11y_aria_label=function(e){return console.warn("REMOVED $.fn.a11y_aria_label incorrect behaviour."),this}});